<style>
  .links line {
    stroke: #ccc;
    opacity: 0.5;
  }

  .nodes circle {
    cursor: pointer;
    fill: blue;
    transition: all 0.15s ease-out;
  }

  .text text {
    cursor: pointer;
    fill: #333;
    text-shadow: -1px -1px 0 #fafafabb, 1px -1px 0 #fafafabb, -1px 1px 0 #fafafabb, 1px 1px 0 #fafafabb;
  }

  .nodes [active],
  .text [active] {
    cursor: pointer;
    fill: red;
  }

  .nodes circle[active] {
    r: 6;
  }

  #graph-wrapper {
    background: #fafafa;
    border-radius: 4px;
    height: auto;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"
  integrity="sha512-FHsFVKQ/T1KWJDGSbrUhTJyS1ph3eRrxI228ND0EGaEp6v4a/vGwPWd3Dtd/+9cI7ccofZvl/wulICEurHN1pg=="
  crossorigin="anonymous"></script>

<div id="graph-wrapper">
  <script>
    const cf_RADIUS = 4;
    const cf_STROKE = 1;
    const cf_FONT_SIZE = 15;
    const cf_TICKS = 100;
    const cf_FONT_BASELINE = 15;
    const cf_MAX_LABEL_LENGTH = 50;

    const cfGraphData = {% include crossfit_notes_graph.json %}

    let cfNodesData = cfGraphData.nodes;
    let cfLinksData = cfGraphData.edges;

    const onCfClick = (d) => {
      window.location = d.path
    };

    const cfElement = document.createElementNS(
      "http://www.w3.org/2000/svg",
      "svg"
    );
    const cfGraphWrapper = document.getElementById('graph-wrapper')

    cfElement.setAttribute("width", cfGraphWrapper.getBoundingClientRect().width);
    cfGraphWrapper.setAttribute("height", window.innerHeight * 0.8);
    cfElement.setAttribute("height", window.innerHeight * 0.8);

    cfGraphWrapper.appendChild(cfElement);

    const cfReportWindowSize = () => {
      cfElement.setAttribute("width", cfGraphWrapper.getBoundingClientRect().width);
      cfGraphWrapper.setAttribute("height", window.innerHeight * 0.8);
      cfElement.setAttribute("height", window.innerHeight * 0.8);
    };

    window.onresize = cfReportWindowSize;

    const cfSvg = d3.select("svg");
    const cfWidth = Number(cfSvg.attr("width"));
    const cfHeight = Number(cfSvg.attr("height"));
    let cfZoomLevel = .2;

    const cfSimulation = d3
      .forceSimulation(cfNodesData)
      .force("charge", d3
        .forceManyBody()
        .strength(-4000)
      )
      .force(
        "link",
        d3
          .forceLink(cfLinksData)
          .id((d) => d.id)
          .distance(150)
      )
      .force("center", d3.forceCenter(cfWidth / 2, cfHeight / 2))
      .stop();

    const g = cfSvg.append("g");
    let link = g.append("g").attr("class", "links").selectAll(".link");
    let node = g.append("g").attr("class", "nodes").selectAll(".node");
    let text = g.append("g").attr("class", "text").selectAll(".text");

    const zoomActions = () => {
      const scale = d3.event.transform;
      cfZoomLevel = scale.k;
      g.attr("transform", scale);

      const zoomOrKeep = (value) => (scale.k >= 1 ? value / scale.k : value);

      const font = Math.max(Math.round(zoomOrKeep(cf_FONT_SIZE)), 1);

      text.attr("font-size", `${font}px`);
      text.attr("y", (d) => d.y - zoomOrKeep(cf_FONT_BASELINE));
      link.attr("stroke-width", zoomOrKeep(cf_STROKE));
      node.attr("r", zoomOrKeep(cf_RADIUS));
    };

    const ticked = () => {
      node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
      text
        .attr("x", (d) => d.x)
        .attr("y", (d) => d.y - cf_FONT_BASELINE / cfZoomLevel);
      link
        .attr("x1", (d) => d.source.x)
        .attr("y1", (d) => d.source.y)
        .attr("x2", (d) => d.target.x)
        .attr("y2", (d) => d.target.y);
    };

    const restart = () => {
      node = node.data(cfNodesData, (d) => d.id);
      node.exit().remove();
      node = node
        .enter()
        .append("circle")
        .attr("r", cf_RADIUS)
        // .attr("fill", (d) => getNodeColor(d))
        .on("click", onCfClick)
        .merge(node);

      link = link.data(cfLinksData, (d) => `${d.source.id}-${d.target.id}`);
      link.exit().remove();
      link = link
        .enter()
        .append("line")
        .attr("stroke-width", cf_STROKE)
        .merge(link);

      node.attr("active", (d) => isCurrentPath(d.path) ? true : null);
      text.attr("active", (d) => isCurrentPath(d.path) ? true : null);

      text = text.data(cfNodesData, (d) => d.label);
      text.exit().remove();
      text = text
        .enter()
        .append("text")
        .text((d) => shorten(d.label.replace(/_*/g, ""), cf_MAX_LABEL_LENGTH))
        .attr("font-size", `${cf_FONT_SIZE}px`)
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "central")
        .on("click", onCfClick)
        .merge(text);

      cfSimulation.nodes(cfNodesData);
      cfSimulation.force("link").links(cfLinksData);
      cfSimulation.alpha(1).restart();
      cfSimulation.stop();

      for (let i = 0; i < cf_TICKS; i++) {
        cfSimulation.tick();
      }

      ticked();
    };

    const zoomHandler = d3
      .zoom()
      .scaleExtent([0.2, 3])
      //.translateExtent([[0,0], [width, height]])
      //.extent([[0, 0], [width, height]])
      .on("zoom", zoomActions);

    zoomHandler(cfSvg);
    restart();

    function isCurrentPath(notePath) {
      return window.location.pathname.includes(notePath)
    }

    function shorten(str, maxLen, separator = ' ') {
      if (str.length <= maxLen) return str;
      return str.substr(0, str.lastIndexOf(separator, maxLen)) + '...';
    }
  </script>
</div>
